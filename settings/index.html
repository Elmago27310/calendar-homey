<!DOCTYPE html>
<html>
    <head>
        <style>
            .icons-info {
                color: grey;
                font-size: smaller;
            }

            .uri-error-hidden {
                display: none;
            }

            .uri-error-show {
                display: block;
                color: red;
                font-weight: bold;
            }
        </style>

        <!-- Homey settings -->
        <script type="text/javascript" src="/homey.js" data-origin="settings"></script>
      </head>
      
      <body>

        <h1 data-i18n="settings.title">
            <!--
                This field will automatically be filled by a translated string with key 'settings.title'.
                Read more about translations at Internationalization.
        	-->
        </h1>

        <fieldset>
            <legend>URI settings</legend>

            <div class="field row">
                <input id="uri" type="text" value="" />
            </div>

        </fieldset>

        <button id="save" class="right">Save changes</button>

        <div id="uri_error" class="uri-error-hidden"></div>

        <p class="icons-info">Icons by <a href="https://icons8.com/">Icons8</a></p>
        
        <script type="text/javascript">
            // a method named 'onHomeyReady' must be present in your code
            function onHomeyReady(Homey) {
                // Tell Homey we're ready to be displayed
                Homey.ready();

                var uriElement = document.getElementById('uri');
                var saveElement = document.getElementById('save');

                // get uri from settings
                Homey.get('uri', (err, uri) => {
                    if (err) return Homey.alert(err);
                    uriElement.value = uri;
                });

                // save uri to settings
                saveElement.addEventListener('click', function(e) {
                    Homey.set('uri', uriElement.value, function(err) {
                        if(err) return Homey.alert(err);
                    });

                    hideError();
                    Homey.alert(Homey.__('settings.saved_alert'), 'info');
                });

                // if uri_failed exists as a setting, show error div
                getUriFailedSetting();

                setInterval(() => getUriFailedSetting(), 3000);
            }

            function hideError() {
                var errorElement = document.getElementById('uri_error');

                errorElement.classList = 'uri-error-hidden';
            }

            function showError(statusCode) {
                var errorElement = document.getElementById('uri_error');

                errorElement.innerHTML = Homey.__('settings.uri_load_failure') + ": '" + statusCode + "'";
                errorElement.classList = 'uri-error-show';
            }

            function getUriFailedSetting() {
                Homey.get('uri_failed', (err, statusCode) => {
                    if (err) {
                        hideError();
                        return;
                    }

                    if (statusCode) {
                        showError(statusCode);
                    }
                });
            }
        </script>

      </body>
</html>